

<!DOCTYPE html>
<html class="no-js" lang="en">
    
    

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width initial-scale=1" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>
             Care Pet ScyllaDB PHP IoT example | ScyllaDB Docs 
        </title>
        <meta name="description" content="ScyllaDB IoT Example Documentation" />
        <link rel="icon" href="_static/img/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="_static/img/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" href="_static/img/favicon-228x228.png" sizes="192x192" />
        <link rel="apple-touch-icon" href="_static/img/favicon-228x228.png" />
        <meta name="msapplication-TileImage" href="_static/img/favicon-228x228.png" />

        
            
            
        

        
            
            <link rel="canonical" href="https://iot.scylladb.com/stable/build-with-php.html"/>
        

        <link rel="author" href="mailto:info@scylladb.com" />

        
            
        <!-- increase expertrec loading priority-->
        <link rel="dns-prefetch" href="https://cse.expertrec.com">

        <!-- increase font loading priority -->
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preload" as="style"
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" />

        <!-- async CSS -->
        <link rel="stylesheet" media="print" onload="this.onload=null;this.removeAttribute('media');"
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" />

        <!-- no-JS fallback -->
        <noscript>
            <link rel="stylesheet"
                href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap" />
        </noscript>
        
            
                <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
            
        
            
                <link rel="stylesheet" type="text/css" href="_static/css/main.css" />
            
        
            
                <link rel="stylesheet" type="text/css" href="_static/sphinx_collapse.css" />
            
        
            
                <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
            
        
    
        
        
            

        <script type="text/javascript" id="documentation_options" data-url_root="./"
            src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/js/runtime.bundle.js"></script>
        <script type="text/javascript" src="_static/js/main.bundle.js"></script>
        
            
                <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
            
        
            
        
            
                <script src="_static/underscore.js"></script>
            
        
            
                <script src="_static/doctools.js"></script>
            
        
            
                <script src="_static/clipboard.min.js"></script>
            
        
            
                <script src="_static/copybutton.js"></script>
            
        
    
            <!- Zendesk tag -->
<meta name='zd-site-verification' content='gq6ltsh3nfex3cnwfy4aj9' />
<!-- Google Tag Manager -->
<script>
    (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            "gtm.start": new Date().getTime(),
            event: "gtm.js"
        });
        var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-T8P2JP");
</script>
<!-- End Google Tag Manager -->

<!-- Expertrec -->
<script>
    var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
    var ci_search = document.createElement("script");
    ci_search.type = "text/javascript";
    ci_search.async = true;
    ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(ci_search, s);
</script>
<!-- End Expertrec -->
        
        <!-- Font Awesome -->
        <script src="https://kit.fontawesome.com/b1870adf6a.js" crossorigin="anonymous"></script>
        <!-- End Font Awesome -->
    </head>

    <body>
        
        <header class="header">
    <div class="header-logo">
        <a class="header-logo__img" href="https://scylladb.com/">
            <img src="_static/img/logo-docs.svg" alt="ScyllaDB Documentation Logo" />
        </a>
        <span class="header-logo__bar"></span>
        <a class="header-logo__text" href="https://docs.scylladb.com/">
            Documentation
        </a>
    </div>
    <div class="header-navigation">
        <ul class="dropdown menu scylla-dropdown scylla-dropdown--header" data-dropdown-menu>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Server
                    <i class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--about-us"></i>
                            ScyllaDB Open Source
                        </a>
                    </li>
                    <li>
                        <a href="https://enterprise.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--enterprise"></i>ScyllaDB Enterprise
                        </a>
                    </li>
                    <li>
                        <a href="https://scylla.docs.scylladb.com/stable/alternator/alternator.html">
                            <i class="scylla-icon scylla-icon--overview"></i>
                            ScyllaDB Alternator
                        </a>
                    </li>
                </ul>
            </li>
            <li class="scylla-dropdown__item">
                <a href="https://docs.scylladb.com/scylla-cloud/" class="scylla-dropdown__title">Cloud</a>
            </li>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Tools <i
                    class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://manager.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--manager"></i>ScyllaDB Manager</a>
                    </li>
                    <li>
                        <a href="https://monitoring.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--monitoring"></i>ScyllaDB
                            Monitoring Stack</a>
                    </li>
                    <li>
                        <a href="https://operator.docs.scylladb.com/">
                            <i class="scylla-icon scylla-icon--operator"></i>ScyllaDB Operator
                        </a>
                    </li>
                </ul>
            </li>
            <li class="scylla-dropdown__item">
                <a href="#" class="scylla-dropdown__title">Drivers <i
                    class="chevron scylla-icon scylla-icon--triangle-down"></i></a>
                <ul class="menu scylla-dropdown__content">
                    <li>
                        <a href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/">
                            <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
                        </a>
                    </li>
                    <li>
                        <a href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/">
                            <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
        <div class="header-button">
            <a href="https://www.scylladb.com/download/" class="button">Download</a>
        </div>
    </div>
    <div class="header-search-box">
        <div class="search-box">
            <ci-search></ci-search>
        </div>
    </div>
    <div class="side-nav-toggle" data-toggle="side-nav">
    <div class="side-nav-toggle__button">
        <img src="_static/img/menu.svg" alt="Menu" />
    </div>
</div>
</header>
        <section
            class="layout  layout--sidebar layout--has-secondary-sidebar ">
            <div class="content large-order-2">
                
                    
                
                
                    <div class="pre-content">
                        <div class="breadcrumbs">
    <span class="bread__item">
        <a href="https://docs.scylladb.com"
            class="bread__highlight">
            <i class="fas fa-home"></i> ScyllaDB Docs
        </a>
    </span>
    <span class="bread__item">
        <a href="index.html"
            class="bread__highlight">
            ScyllaDB IoT Example Documentation
        </a>
    </span>
    
    <span class="bread__item bread__item--last">Care Pet ScyllaDB PHP IoT example</span>
</div>
                    </div>
                
                <section id="care-pet-scylladb-php-iot-example">
<h1>Care Pet ScyllaDB PHP IoT example<a class="headerlink" href="#care-pet-scylladb-php-iot-example" title="Permalink to this headline">¶</a></h1>
<p>This example project demonstrates a generic IoT use case for ScyllaDB in PHP.</p>
<p>Here you will find a list of possible drivers to integrate with.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>PHP Version</th>
<th>Driver</th>
</tr>
</thead>
<tbody>
<tr>
<td>PHP 7.1</td>
<td><a href="https://github.com/datastax/php-driver">DataStax PHP Driver</a></td>
</tr>
<tr>
<td>PHP 8.2  [x]</td>
<td><a href="https://github.com/qkdreyer/cassandra-php-driver">ScyllaDB PHP Driver (community)</a></td>
</tr>
</tbody>
</table><p>You will need to build the driver following the instructions of each repository. We strongly recommend that you go for
PHP 8.x since this project still being maintained and developed by community itself.</p>
<p>The documentation for this application and the guided exercise is <a class="reference internal" href="getting-started.html"><span class="doc">here</span></a>.</p>
<section id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>The application allows the tracking of the pets health indicators and it consist in a CLI of three parts:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>php scylla migrate</td>
<td>creates the <code>carepet</code> keyspace and tables</td>
</tr>
<tr>
<td>php scylla simulate</td>
<td>generates a pet health data and pushes it into the storage</td>
</tr>
<tr>
<td>php scylla serve</td>
<td>REST API service for tracking pets health state</td>
</tr>
</tbody>
</table><p>Prerequisites:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.docker.com/">docker</a></p></li>
<li><p><a class="reference external" href="https://docs.docker.com/compose/">docker-compose</a></p></li>
</ul>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>To run a local <strong>ScyllaDB cluster</strong> consisting of three nodes and the <strong>PHP Environment</strong> with
the help of <code class="docutils literal notranslate"><span class="pre">docker</span></code> and <code class="docutils literal notranslate"><span class="pre">docker-compose</span></code> execute:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker-compose up -d
</pre></div>
</div>
<p>Docker-compose will spin up three nodes which are:</p>
<ul class="simple">
<li><p>carepet-scylla1</p></li>
<li><p>carepet-scylla2</p></li>
<li><p>carepet-scylla3</p></li>
</ul>
<p>If you want to see your containers running, run the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> command, and you should see something like this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker ps
CONTAINER ID   IMAGE                    COMMAND                  CREATED       STATUS       PORTS                                                                      NAMES
4e351dfe3987   scylladb/scylla          <span class="s2">&quot;/docker-entrypoint.…&quot;</span>   <span class="m">1</span> minute ago   Up <span class="m">1</span> minute   <span class="m">22</span>/tcp, <span class="m">7000</span>-7001/tcp, <span class="m">7199</span>/tcp, <span class="m">9042</span>/tcp, <span class="m">9160</span>/tcp, <span class="m">9180</span>/tcp, <span class="m">10000</span>/tcp   carepet-scylla2
9e7e4d3992df   scylladb/scylla          <span class="s2">&quot;/docker-entrypoint.…&quot;</span>   <span class="m">1</span> minute ago   Up <span class="m">1</span> minute   <span class="m">22</span>/tcp, <span class="m">7000</span>-7001/tcp, <span class="m">7199</span>/tcp, <span class="m">9042</span>/tcp, <span class="m">9160</span>/tcp, <span class="m">9180</span>/tcp, <span class="m">10000</span>/tcp   carepet-scylla3
7e2b1b94389b   scylladb/scylla          <span class="s2">&quot;/docker-entrypoint.…&quot;</span>   <span class="m">1</span> minute ago   Up <span class="m">1</span> minute   <span class="m">22</span>/tcp, <span class="m">7000</span>-7001/tcp, <span class="m">7199</span>/tcp, <span class="m">9042</span>/tcp, <span class="m">9160</span>/tcp, <span class="m">9180</span>/tcp, <span class="m">10000</span>/tcp   carepet-scylla1
</pre></div>
</div>
<blockquote>
<div><p>If you have any error regarding “premature connection”, restart your docker instance and wait a minute until
your ScyllaDB connection be established.</p>
</div></blockquote>
<section id="useful-commands">
<h3>Useful Commands<a class="headerlink" href="#useful-commands" title="Permalink to this headline">¶</a></h3>
<p>Here’s a list of everything that you can execute and make your own research through the application.</p>
<section id="php-application-commands">
<h4>PHP Application Commands<a class="headerlink" href="#php-application-commands" title="Permalink to this headline">¶</a></h4>
<p>These commands you can execute by <code class="docutils literal notranslate"><span class="pre">entering</span> <span class="pre">the</span> <span class="pre">container</span></code> or through <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span></code> remotely:</p>
<section id="configuring-the-environment">
<h5>Configuring the Environment<a class="headerlink" href="#configuring-the-environment" title="Permalink to this headline">¶</a></h5>
<p>Make a copy of <code class="docutils literal notranslate"><span class="pre">.env.example</span></code> and name it <code class="docutils literal notranslate"><span class="pre">.env</span></code>. This file will store your application secrets.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cp .env.example .env
</pre></div>
</div>
<p>By default, the config to connect on your local ScyllaDB instances will be ready to use.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Development</span>
<span class="n">DB_KEYSPACE</span><span class="o">=</span><span class="s2">&quot;carepet&quot;</span>
<span class="n">DB_NODES</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span>
<span class="n">DB_USERNAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="n">DB_PASSWORD</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="n">DB_PORT</span><span class="o">=</span><span class="mi">9042</span>

<span class="c1"># Production (Cloud)</span>
<span class="c1">#DB_KEYSPACE=&quot;carepet&quot;</span>
<span class="c1">#DB_NODES=&quot;node-0.aws_sa_east_1.c106d1ac5f3117a20bf0.clusters.scylla.cloud&quot;</span>
<span class="c1">#DB_USERNAME=&quot;scylla&quot;</span>
<span class="c1">#DB_PASSWORD=&quot;p50bonFq8cuxwXS&quot;</span>
<span class="c1">#DB_PORT=9042</span>
</pre></div>
</div>
<blockquote>
<div><p>If you want to use ScyllaDB Cloud, remember to change at your keyspace the <strong>Replication Factor</strong> related to
for each environment.</p>
</div></blockquote>
</section>
<section id="initializing-keyspace">
<h5>Initializing Keyspace:<a class="headerlink" href="#initializing-keyspace" title="Permalink to this headline">¶</a></h5>
<p>First, let’s create our keyspace using CQLSH.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker <span class="nb">exec</span> -it carepet-scylla1 cqlsh
Connected to  at <span class="m">10</span>.10.5.2:9042.
<span class="o">[</span>cqlsh <span class="m">5</span>.0.1 <span class="p">|</span> Cassandra <span class="m">3</span>.0.8 <span class="p">|</span> CQL spec <span class="m">3</span>.3.1 <span class="p">|</span> Native protocol v4<span class="o">]</span>
Use HELP <span class="k">for</span> help.
cqlsh&gt; CREATE KEYSPACE IF NOT EXISTS carepet WITH <span class="nv">replication</span> <span class="o">=</span> <span class="o">{</span> <span class="s1">&#39;class&#39;</span>: <span class="s1">&#39;NetworkTopologyStrategy&#39;</span>, <span class="s1">&#39;replication_factor&#39;</span>: <span class="s1">&#39;2&#39;</span> <span class="o">}</span><span class="p">;</span>
cqlsh&gt;
</pre></div>
</div>
<p>Then you can run the CLI command to migrate all your tables inside the keyspace.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ php scylla migrate
<span class="o">[</span>INFO<span class="o">]</span> Fetching Migrations... 
<span class="o">[</span>INFO<span class="o">]</span> Migrated: /var/www/migrations/1-create_keyspace.cql 
<span class="o">[</span>INFO<span class="o">]</span> Migrated: /var/www/migrations/2-create_owner_table.cql 
<span class="o">[</span>INFO<span class="o">]</span> Migrated: /var/www/migrations/3-create_pets_table.cql 
<span class="o">[</span>INFO<span class="o">]</span> Migrated: /var/www/migrations/4-create_sensors_table.cql 
<span class="o">[</span>INFO<span class="o">]</span> Migrated: /var/www/migrations/5-create_measurements_table.cql 
<span class="o">[</span>INFO<span class="o">]</span> Migrated: /var/www/migrations/6-create_sensor_avg_table.cql 
<span class="o">[</span>INFO<span class="o">]</span> Done :D 
</pre></div>
</div>
</section>
<section id="starting-web-server">
<h5>Starting Web Server:<a class="headerlink" href="#starting-web-server" title="Permalink to this headline">¶</a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ php scylla serve
<span class="o">[</span>INFO<span class="o">]</span> CarePet Web started!
<span class="o">[</span>INFO<span class="o">]</span> Development Server: http://0.0.0.0:8000
<span class="o">[</span>Thu Jan  <span class="m">5</span> <span class="m">17</span>:32:01 <span class="m">2023</span><span class="o">]</span> PHP <span class="m">7</span>.4.33 Development Server <span class="o">(</span>http://0.0.0.0:8000<span class="o">)</span> started
</pre></div>
</div>
</section>
<section id="simulate-environment-sensors">
<h5>Simulate Environment Sensors:<a class="headerlink" href="#simulate-environment-sensors" title="Permalink to this headline">¶</a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ php scylla simulate
<span class="o">[</span>INFO<span class="o">]</span> Starting Sensor simulator... 
<span class="o">[</span>INFO<span class="o">]</span> Batch: <span class="m">0</span>
<span class="o">[</span>INFO<span class="o">]</span> Owner 593dec12-6bea-3c93-8f49-26d8b6d589b1 
<span class="o">[</span>INFO<span class="o">]</span> Pet: 14d9f304-5600-34af-8622-3d4505d617d7 <span class="p">|</span> Owner 593dec12-6bea-3c93-8f49-26d8b6d589b1
<span class="o">[</span>INFO<span class="o">]</span> Sensor: 869bd01e-e0ba-364f-bbfb-8c7c496a3318 <span class="o">(</span>R<span class="o">)</span> <span class="p">|</span> Pet 14d9f304-5600-34af-8622-3d4505d617d7 
<span class="o">[</span>INFO<span class="o">]</span> Sensor: c86f63b0-1439-3404-8750-b71b90a685cb <span class="o">(</span>L<span class="o">)</span> <span class="p">|</span> Pet 14d9f304-5600-34af-8622-3d4505d617d7 
<span class="o">[</span>INFO<span class="o">]</span> Sensor: e0550426-8832-3d17-9025-77726b3009c5 <span class="o">(</span>P<span class="o">)</span> <span class="p">|</span> Pet 14d9f304-5600-34af-8622-3d4505d617d7 
<span class="o">[</span>INFO<span class="o">]</span> Sensor: bf960c81-8e0f-3012-b50d-18596b50db18 <span class="o">(</span>P<span class="o">)</span> <span class="p">|</span> Pet 14d9f304-5600-34af-8622-3d4505d617d7 
<span class="o">[</span>INFO<span class="o">]</span> Sensor: 933245de-812e-34e4-8d50-2ab072726217 <span class="o">(</span>T<span class="o">)</span> <span class="p">|</span> Pet 14d9f304-5600-34af-8622-3d4505d617d7 
<span class="o">[</span>INFO<span class="o">]</span> Pet: 319ec566-d6b0-3868-ac5e-76253ee7c236 <span class="p">|</span> Owner 593dec12-6bea-3c93-8f49-26d8b6d589b1
<span class="o">[</span>INFO<span class="o">]</span> ...
</pre></div>
</div>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">final class SimulateCommand extends AbstractCommand</span>
<span class="x">{</span>

<span class="x">    public function __construct(</span>
<span class="x">        private readonly OwnerRepository $ownerRepository,</span>
<span class="x">        private readonly PetRepository    $petRepository,</span>
<span class="x">        private readonly SensorRepository $sensorRepository</span>
<span class="x">    )</span>
<span class="x">    {</span>
<span class="x">    }</span>

<span class="x">    const AMOUNT_BASE = 50000;</span>

<span class="x">    public function __invoke(array $args = []): int</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;info(&#39;Starting Sensor simulator...&#39;);</span>
<span class="x">        foreach (range(0, self::AMOUNT_BASE) as $i) {</span>
<span class="x">            $this-&gt;info(&quot;Batch: &quot; . $i);</span>
<span class="x">            [$ownerDTO, $petsDTO] = $this-&gt;generateFakeData();</span>

<span class="x">            $this-&gt;ownerRepository-&gt;create($ownerDTO);</span>
<span class="x">            $this-&gt;info(sprintf(&#39;Owner %s&#39;, $ownerDTO-&gt;id));</span>

<span class="x">            $petsDTO-&gt;each(function ($petDTO) {</span>
<span class="x">                $this-&gt;info(sprintf(&#39;Pet: %s | Owner %s&#39;, $petDTO-&gt;id-&gt;uuid(), $petDTO-&gt;ownerId));</span>
<span class="x">                $this-&gt;petRepository-&gt;create($petDTO);</span>

<span class="x">                SensorFactory::makeMany(5, [&#39;pet_id&#39; =&gt; $petDTO-&gt;id])</span>
<span class="x">                    -&gt;each($this-&gt;handleSensors());</span>
<span class="x">            });</span>
<span class="x">        }</span>
<span class="x">        $this-&gt;info(&#39;Done :D&#39;);</span>

<span class="x">        return self::SUCCESS;</span>
<span class="x">    }</span>

<span class="x">    private function generateFakeData(): array</span>
<span class="x">    {</span>
<span class="x">        $ownerDTO = OwnerFactory::make();</span>
<span class="x">        $petsDTO = PetFactory::makeMany(5, [&#39;owner_id&#39; =&gt; $ownerDTO-&gt;id]);</span>

<span class="x">        return [$ownerDTO, $petsDTO];</span>
<span class="x">    }</span>

<span class="x">    private function handleSensors(): Closure</span>
<span class="x">    {</span>
<span class="x">        return function (SensorDTO $sensorDTO) {</span>
<span class="x">            $this-&gt;sensorRepository-&gt;create($sensorDTO);</span>
<span class="x">            $this-&gt;info(sprintf(</span>
<span class="x">                &#39;Sensor: %s (%s) | Pet %s&#39;,</span>
<span class="x">                $sensorDTO-&gt;id,</span>
<span class="x">                $sensorDTO-&gt;type-&gt;name,</span>
<span class="x">                $sensorDTO-&gt;petId</span>
<span class="x">            ));</span>
<span class="x">        };</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
</section>
<section id="inserting-data">
<h5>Inserting Data<a class="headerlink" href="#inserting-data" title="Permalink to this headline">¶</a></h5>
<p>You can use <code class="docutils literal notranslate"><span class="pre">Cassandra::cluster()</span></code> and setup your cluster.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">use Cassandra;</span>
<span class="x">use Cassandra\Cluster;</span>
<span class="x">use Cassandra\Cluster\Builder;</span>
<span class="x">use Cassandra\FutureRows;</span>
<span class="x">use Cassandra\Session;</span>
<span class="x">use Cassandra\SimpleStatement;</span>

<span class="x">class Connector</span>
<span class="x">{</span>
<span class="x">    public Builder $connectionBuilder;</span>
<span class="x">    public Cluster $cluster;</span>
<span class="x">    public Session $session;</span>
<span class="x">    public SimpleStatement $query;</span>

<span class="x">    const BASE_TIMEOUT = 10;</span>

<span class="x">    public function __construct(array $config)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;connectionBuilder = Cassandra::cluster()</span>
<span class="x">            -&gt;withContactPoints($config[&#39;nodes&#39;])</span>
<span class="x">            -&gt;withDefaultConsistency($config[&#39;consistency_level&#39;])</span>
<span class="x">            -&gt;withPort($config[&#39;port&#39;]);</span>

<span class="x">        if (!empty($config[&#39;username&#39;] &amp;&amp; !empty($config[&#39;password&#39;]))) {</span>
<span class="x">            $this-&gt;connectionBuilder = $this-&gt;connectionBuilder-&gt;withCredentials($config[&#39;username&#39;], $config[&#39;password&#39;]);</span>
<span class="x">        }</span>
<span class="x">        $this-&gt;cluster = $this-&gt;connectionBuilder-&gt;build();</span>

<span class="x">        $this-&gt;session = $this-&gt;cluster-&gt;connect($config[&#39;keyspace&#39;]);</span>
<span class="x">    }</span>

<span class="x">    public function setKeyspace(string $keyspace = &#39;&#39;): self</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;session-&gt;close(self::BASE_TIMEOUT);</span>
<span class="x">        $this-&gt;session = $this-&gt;cluster-&gt;connect($keyspace);</span>

<span class="x">        return $this;</span>
<span class="x">    }</span>

<span class="x">    public function prepare(string $query): self</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;query = new SimpleStatement($query);</span>

<span class="x">        return $this;</span>
<span class="x">    }</span>

<span class="x">    public function execute(): FutureRows</span>
<span class="x">    {</span>
<span class="x">        return $this-&gt;session-&gt;executeAsync($this-&gt;query, []);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">use App\Core\Entities\AbstractDTO;</span>
<span class="x">use Cassandra\Rows;</span>

<span class="x">abstract class AbstractRepository</span>
<span class="x">{</span>
<span class="x">    public string $table = &#39;&#39;;</span>

<span class="x">    public string $primaryKey = &#39;&#39;;</span>

<span class="x">    public Connector $connection;</span>

<span class="x">    public array $keys = [];</span>

<span class="x">    public function __construct(Connector $connector)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;connection = $connector;</span>
<span class="x">    }</span>

<span class="x">    public function getById(string $id): Rows</span>
<span class="x">    {</span>
<span class="x">        $query = sprintf(&quot;SELECT * FROM %s WHERE %s = %s&quot;, $this-&gt;table, $this-&gt;primaryKey, $id);</span>

<span class="x">        return $this-&gt;connection</span>
<span class="x">            -&gt;prepare($query)</span>
<span class="x">            -&gt;execute()</span>
<span class="x">            -&gt;get(Connector::BASE_TIMEOUT);</span>
<span class="x">    }</span>

<span class="x">    public function all(): Rows</span>
<span class="x">    {</span>
<span class="x">        return $this-&gt;connection</span>
<span class="x">            -&gt;prepare(sprintf(&#39;SELECT * FROM %s&#39;, $this-&gt;table))</span>
<span class="x">            -&gt;execute()</span>
<span class="x">            -&gt;get(Connector::BASE_TIMEOUT);</span>
<span class="x">    }</span>

<span class="x">    public function create(AbstractDTO $dto): void</span>
<span class="x">    {</span>
<span class="x">        $keys = array_keys($dto-&gt;toDatabase());</span>
<span class="x">        $dataValues = array_values($dto-&gt;toDatabase());</span>

<span class="x">        foreach ($dataValues as $key =&gt; $value) {</span>
<span class="x">            if (is_string($value) &amp;&amp; !in_array($keys[$key], $this-&gt;keys)) {</span>
<span class="x">                $value = addslashes($value);</span>
<span class="x">                $dataValues[$key] = &quot;&#39;$value&#39;&quot;;</span>
<span class="x">            }</span>
<span class="x">        }</span>

<span class="x">        $query = sprintf(</span>
<span class="x">            &quot;INSERT INTO %s (%s) VALUES (%s)&quot;,</span>
<span class="x">            $this-&gt;table,</span>
<span class="x">            implode(&#39;, &#39;, $keys),</span>
<span class="x">            implode(&#39;, &#39;, $dataValues)</span>
<span class="x">        );</span>


<span class="x">        $this-&gt;connection</span>
<span class="x">            -&gt;prepare($query)</span>
<span class="x">            -&gt;execute();</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
</section>
</section>
<section id="scylladb-commands">
<h4>ScyllaDB Commands<a class="headerlink" href="#scylladb-commands" title="Permalink to this headline">¶</a></h4>
<section id="running-nodetool">
<h5>Running Nodetool:<a class="headerlink" href="#running-nodetool" title="Permalink to this headline">¶</a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker <span class="nb">exec</span> -it carepet-scylla1 nodetool <span class="nv">status</span>
<span class="o">=======================</span>
Datacenter: <span class="nv">datacenter1</span>
<span class="o">=======================</span>
<span class="nv">Status</span><span class="o">=</span>Up/Down
<span class="p">|</span>/ <span class="nv">State</span><span class="o">=</span>Normal/Leaving/Joining/Moving
--  Address    Load       Tokens       Owns    Host ID                               Rack
UN  <span class="m">10</span>.10.5.2  <span class="m">212</span> KB     <span class="m">256</span>          ?       f6121e15-48df-4b31-b725-3ad2795b8b94  rack1
UN  <span class="m">10</span>.10.5.3  <span class="m">1</span>.06 MB    <span class="m">256</span>          ?       871795f3-67d2-47ba-83ef-15714b89c02a  rack1
UN  <span class="m">10</span>.10.5.4  <span class="m">1</span>.06 MB    <span class="m">256</span>          ?       cbe74a63-2cf4-41c2-bf7f-c831c0d2689f  rack1
</pre></div>
</div>
</section>
<section id="running-container-shell">
<h5>Running Container Shell:<a class="headerlink" href="#running-container-shell" title="Permalink to this headline">¶</a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker <span class="nb">exec</span> -it carepet-scylla1 bash

   _____            _ _       _____  ____
  / ____<span class="p">|</span>          <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>     <span class="p">|</span>  __ <span class="se">\|</span>  _ <span class="se">\</span>
 <span class="p">|</span> <span class="o">(</span>___   ___ _   _<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> __ _<span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span>
  <span class="se">\_</span>__ <span class="se">\ </span>/ __<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>/ _<span class="sb">`</span> <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>  _ &lt;
  ____<span class="o">)</span> <span class="p">|</span> <span class="o">(</span>__<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="o">(</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span>__<span class="p">|</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span>
 <span class="p">|</span>_____/ <span class="se">\_</span>__<span class="p">|</span><span class="se">\_</span>_, <span class="p">|</span>_<span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>_,_<span class="p">|</span>_____/<span class="p">|</span>____/
               __/ <span class="p">|</span>
              <span class="p">|</span>___/
Nodetool:
        nodetool <span class="nb">help</span>
CQL Shell:
        cqlsh
More documentation available at:
        http://www.scylladb.com/doc/

root@7e2b1b94389b:/#
</pre></div>
</div>
</section>
<section id="inspecting-a-container">
<h5>Inspecting a Container<a class="headerlink" href="#inspecting-a-container" title="Permalink to this headline">¶</a></h5>
<p><em>You can inspect any node by means of the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">inspect</span></code> command as follows. For example:</em></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker inspect carepet-scylla1
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;Id&quot;</span>: <span class="s2">&quot;7e2b1b94389b36c494093db8e119c2b8c5167339f20e03d9bfa070e8e46f8430&quot;</span>,
        <span class="s2">&quot;Created&quot;</span>: <span class="s2">&quot;2023-01-05T17:36:59.038609825Z&quot;</span>,
        <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/docker-entrypoint.py&quot;</span>,
        <span class="s2">&quot;Args&quot;</span>: <span class="o">[</span>
            <span class="s2">&quot;--smp&quot;</span>,
            <span class="s2">&quot;1&quot;</span>
        <span class="o">]</span>,
        <span class="s2">&quot;State&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;Status&quot;</span>: <span class="s2">&quot;running&quot;</span>,
            <span class="s2">&quot;Running&quot;</span>: true,
            <span class="s2">&quot;Paused&quot;</span>: false,
            <span class="s2">&quot;Restarting&quot;</span>: <span class="nb">false</span>
            ...
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
<section id="get-node-ip-address">
<h6>Get Node IP Address:<a class="headerlink" href="#get-node-ip-address" title="Permalink to this headline">¶</a></h6>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ docker inspect -f <span class="s1">&#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> carepet-scylla1
<span class="m">10</span>.10.5.2
</pre></div>
</div>
</section>
</section>
</section>
</section>
</section>
</section>

                
                    <div class="post-content">
                        <div class="content-navigation">
    <div class="navigation navigation--prev">
        
            <a class="navigation__link" href="build-with-python.html">
                <button class="navigation__button">
                    <i class="scylla-icon scylla-icon--chevron-left"></i>
                </button>
                <div class="navigation__title">
                    <span class="colored">PREVIOUS</span> <br />Build an IoT App with Python
                </div>
            </a>
        
    </div>
    <div class="navigation navigation--next">
        
            <a class="navigation__link" href="build-with-rust.html">
                <div class="navigation__title">
                    <span class="colored">NEXT</span> <br />Build an IoT App with Rust
                </div>
                <button class="navigation__button">
                    <i class="scylla-icon scylla-icon--chevron-right"></i>
                </button>
            </a>
        
    </div>
</div>
                        <!-- Post content text -->
                    </div>
                
            </div>
            <div class="sidebar-left  large-order-1">
                
                    
                        <div id="side-nav" class="side-nav custom-scroll-bar" data-closable data-toggler=".show">
    <button class="collapsible-button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
    </button>
    <div class="side-nav-content">
        <div class="side-nav__search">
            <div class="search-box">
                <ci-search></ci-search>
            </div>
        </div>
        <div class="side-nav__title">
            ScyllaDB IoT Example Documentation
        </div>
        <div class="side-nav__versions"><ul class="dropdown menu scylla-dropdown scylla-dropdown--versions" data-dropdown-menu>
    <li class="scylla-dropdown__item">
        <a class="scylla-dropdown__title" href="#">
            
                master
            
            <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
        </a>
        <ul class="menu scylla-dropdown__content">
            
                
                    <li>
                        <a href="build-with-php.html">master</a>
                    </li>
                
            
            
        </ul>
    </li>
</ul></div>
        <div class="side-nav__content">
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started with CarePet: A sample IoT App</a></li>
<li class="toctree-l1"><a class="reference internal" href="design_and_data_model.html">Design and Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-with-go.html">Build with Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-with-javascript.html">Build with JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-with-java.html">Build with Java</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-with-python.html">Build with Python</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Build with PHP</a></li>
<li class="toctree-l1"><a class="reference internal" href="build-with-rust.html">Build with Rust</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/scylladb/care-pet">Care-Pet GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.scylladb.com/2020/09/09/carepet-an-example-iot-use-case-for-hands-on-app-developers/">Care-Pet Blog</a></li>
</ul>

        </div>
    </div>
</div>
                    
                
            </div>
            
                <div class="sidebar-right large-order-3">
                    <div class="secondary-side-nav custom-scroll-bar">
    
    <ul class="contribute">
        <li class="contribute__item">
            <a href="https://github.com/scylladb/care-pet/issues/new?title=docs:%20Issue in page Care Pet ScyllaDB PHP IoT example&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://iot.scylladb.com/master/build-with-php%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix&labels=documentation"
                target="_blank">
                <i class="icon fab fa-github" aria-hidden="true"></i>Create an issue
            </a>
        </li>
        
            <li class="contribute__item">
                <a href="https://github.com/scylladb/care-pet/edit/master/docs/build-with-php.md"
                    target="_blank">
                    <i class="icon fa fa-edit" aria-hidden="true"></i>Edit this page
                </a>
            </li>
        
    </ul>

    
        <div class="secondary-side-nav__content">
            <p class="topic-title">On this page</p>
            <ul>
<li><a class="reference internal" href="#">Care Pet ScyllaDB PHP IoT example</a><ul>
<li><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li><a class="reference internal" href="#setup">Setup</a><ul>
<li><a class="reference internal" href="#useful-commands">Useful Commands</a><ul>
<li><a class="reference internal" href="#php-application-commands">PHP Application Commands</a><ul>
<li><a class="reference internal" href="#configuring-the-environment">Configuring the Environment</a></li>
<li><a class="reference internal" href="#initializing-keyspace">Initializing Keyspace:</a></li>
<li><a class="reference internal" href="#starting-web-server">Starting Web Server:</a></li>
<li><a class="reference internal" href="#simulate-environment-sensors">Simulate Environment Sensors:</a></li>
<li><a class="reference internal" href="#inserting-data">Inserting Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scylladb-commands">ScyllaDB Commands</a><ul>
<li><a class="reference internal" href="#running-nodetool">Running Nodetool:</a></li>
<li><a class="reference internal" href="#running-container-shell">Running Container Shell:</a></li>
<li><a class="reference internal" href="#inspecting-a-container">Inspecting a Container</a><ul>
<li><a class="reference internal" href="#get-node-ip-address">Get Node IP Address:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
    
</div>
                </div>
            
        </section>

        <footer class="footer">
    <div class="footer-group">
        <div class="footer-top">
            <a class="footer-logo" href="https://www.scylladb.com">
                <img src="_static/img/logo-scylla-horizontal-RGB.svg" alt="Logo" />
            </a>
            <div class="footer-links">
                <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
                <a class="footer-links__link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
                <a class="footer-links__link" href="https://www.scylladb.com/company/">About Us</a>
            </div>
            <div class="footer-actions">
                <a class="footer-actions__link" href="https://groups.google.com/g/scylladb-users" target="_blank">
                    <span data-tooltip tabindex="1" title="User mailing list" data-position="bottom">
                        <img src="_static/img/icons/icon-mail-list.svg" alt="Mail List Icon" />
                    </span>
                </a>
                <a class="footer-actions__link" href="http://slack.scylladb.com/" target="_blank">
                    <span data-tooltip tabindex="1" title="User Slack channel" data-position="bottom">
                        <img src="_static/img/icons/icon-slack.svg" alt="Slack Icon" />
                    </span>
                </a>
                <a class="footer-actions__link" href="https://forum.scylladb.com/" target="_blank">
                    <span data-tooltip tabindex="1" title="Community forum" data-position="bottom">
                        <img src="_static/img/icons/icon-forum.svg" alt="Forum Icon" />
                    </span>
                </a>
            </div>
        </div>

        <div class="footer-bottom">
            
                <div class="footer-bottom__copyright">
                    
                        
                            &#169; 2023, ScyllaDB. All rights reserved.
                        
                    
                </div>
            
            
                <div class="footer-bottom__last-updated">
                    
                        Last updated on 21 March 2023.
                    
                </div>
            
            <div class="footer-bottom__version">
                Powered by
                <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a> &amp;
                <a href="https://sphinx-theme.scylladb.com/">ScyllaDB Theme 1.3.5</a>
            </div>
        </div>
    </div>
</footer>

        <noscript>
            <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP" height="0" width="0"
                style="display: none; visibility: hidden"></iframe>
        </noscript>
    </body>

</html>